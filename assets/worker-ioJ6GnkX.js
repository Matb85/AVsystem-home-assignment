var y=Object.defineProperty;var U=(h,n,c)=>n in h?y(h,n,{enumerable:!0,configurable:!0,writable:!0,value:c}):h[n]=c;var r=(h,n,c)=>U(h,typeof n!="symbol"?n+"":n,c);(function(){"use strict";class h{constructor(e,s,i,o){r(this,"type");r(this,"passage",0);r(this,"floor");r(this,"direction");r(this,"ID");r(this,"specialCall");this.type=e,this.floor=s,this.direction=i,this.ID=o,this.specialCall=!1}setPassage(e){this.passage=e}getType(){return this.type}getFloor(){return this.floor}getPassage(){return this.passage}getDirection(){return this.direction}getID(){return this.ID}setSpecialCall(e){this.specialCall=e}isSpecialCall(){return this.specialCall}}function n(t){return new Promise(e=>setTimeout(e,t))}var c=(t=>(t[t.BEFORE_AFTERNOON=0]="BEFORE_AFTERNOON",t[t.AFTER_AFTERNOON=1]="AFTER_AFTERNOON",t))(c||{}),a=(t=>(t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t))(a||{}),g=(t=>(t[t.EXIT=0]="EXIT",t[t.ENTRY=1]="ENTRY",t))(g||{});function N(t,e){if(t.isSpecialCall()||e.isSpecialCall())return t.isSpecialCall()&&!e.isSpecialCall()?-1:!t.isSpecialCall()&&e.isSpecialCall()?1:0;if(t.getPassage()==e.getPassage()){if(t.getPassage()==1||t.getPassage()==3)return t.getFloor()<e.getFloor()?-1:t.getFloor()>e.getFloor()?1:0;if(t.getPassage()==2)return t.getFloor()>e.getFloor()?-1:t.getFloor()<e.getFloor()?1:0}else if(t.getPassage()>e.getPassage())return 1;return-1}const P=t=>(t+1>>>1)-1,f=t=>(t<<1)+1,p=t=>t+1<<1;class _{constructor(){r(this,"_heap");r(this,"top",0);this._heap=[]}size(){return this._heap.length}getHeap(){return this._heap}isEmpty(){return this.size()==0}peek(){return this._heap[this.top]}push(...e){return e.forEach(s=>{this._heap.push(s),this._siftUp()}),this.size()}remove(e){for(let s=0;s<this.size();s++)if(this._heap[s].getID()==e.getID()&&this._heap[s].getType()==e.getType()){this._heap.splice(s,1);break}this._siftDown()}pop(){const e=this.peek(),s=this.size()-1;return s>this.top&&this._swap(this.top,s),this._heap.pop(),this._siftDown(),e}_greater(e,s){return N(this._heap[e],this._heap[s])==-1}_swap(e,s){[this._heap[e],this._heap[s]]=[this._heap[s],this._heap[e]]}_siftUp(){let e=this.size()-1;for(;e>this.top&&this._greater(e,P(e));)this._swap(e,P(e)),e=P(e)}_siftDown(){let e=this.top;for(;f(e)<this.size()&&this._greater(f(e),e)||p(e)<this.size()&&this._greater(p(e),e);){let s=p(e)<this.size()&&this._greater(p(e),f(e))?p(e):f(e);this._swap(e,s),e=s}}}class D{constructor(e,s,i,o,l,F){r(this,"RUNNING",!0);r(this,"entryCalls",[]);r(this,"exitCalls",[]);r(this,"sequence",new _);r(this,"ID");r(this,"currentFloor");r(this,"direction",a.UP);r(this,"idle",!0);r(this,"c");r(this,"N");r(this,"L");r(this,"currentPassengers",[]);r(this,"floors");this.ID=e,this.N=o,this.L=l,this.c=i,this.currentFloor=Math.floor(o/2),this.floors=F,this.startPolling(),s==c.AFTER_AFTERNOON?this.upPeakThread():this.zoningThread(),this.animateElevator()}destroy(){this.RUNNING=!1,this.entryCalls=[],this.exitCalls=[]}setCurrentFloor(e){this.currentFloor=e}async startPolling(){for(;this.RUNNING;)this.performJob(),await n(200)}async upPeakThread(){for(;this.RUNNING;){if(this.idle&&(await n(4e3),this.idle&&this.currentFloor!=0)){const e=new h(0,0,0,"");e.setPassage(1),e.setSpecialCall(!0),this.sequence.push(e)}await n(200)}}async zoningThread(){const e=Math.ceil(this.N/this.L);for(;this.RUNNING;){if(this.idle&&(await n(4e3),this.idle&&this.currentFloor!=this.ID*e)){const s=new h(0,this.ID*e,0,"");s.setPassage(1),s.setSpecialCall(!0),this.sequence.push(s)}await n(200)}}checkSequence(e){if(e.getType()==g.ENTRY&&e.getFloor()==this.currentFloor&&this.currentPassengers.length<this.c.capacity){this.floors.peopleWaiting[e.getFloor()]-=1;for(let i=0;i<this.exitCalls.length;++i){const o=this.exitCalls[i];if(o.getID()==e.getID()){this.setExitCallPassage(o),this.currentPassengers.push(o.getFloor()),this.sequence.push(o),this.exitCalls.splice(i,1);break}}this.sequence.remove(e)}if(this.sequence.isEmpty())return;const s=this.sequence.getHeap().filter(i=>i.getFloor()==this.currentFloor);for(const i of s){if(i.getType()==g.EXIT){this.sequence.remove(i);continue}if(i.getType()==g.ENTRY&&i.getFloor()==e.getFloor()&&this.currentPassengers.length<this.c.capacity){for(let o=0;o<this.exitCalls.length;++o){const l=this.exitCalls[o];if(l.getID()==i.getID()){this.setExitCallPassage(l),this.currentPassengers.push(l.getFloor()),this.sequence.push(l),this.exitCalls.splice(o,1);break}}this.floors.peopleWaiting[e.getFloor()]-=1,this.sequence.remove(i)}}}async performJob(){if(this.sequence.size()==0||!this.idle)return;const e=this.sequence.peek();if(e.getFloor()==this.currentFloor){this.checkSequence(e),this.idle=!0;return}for(this.idle=!1,e.getFloor()<this.currentFloor?this.direction=a.DOWN:this.direction=a.UP,this.redefinePassage(),await n(this.c.passengerLoadingTime);this.currentFloor!=e.getFloor()&&this.currentFloor>=0&&this.currentFloor<=this.N-1;){if(this.idle=!1,this.direction==a.UP&&this.currentFloor!=this.N-1)this.currentFloor+=1;else if(this.direction==a.DOWN&&this.currentFloor!=0)this.currentFloor-=1;else{console.log(`



! + ! + ! Elevator is out of range - this.performJob() ! + ! + !



`);break}await n(this.c.velocity*this.c.interFloorHeight*200),this.redefinePassage(),this.checkSequence(e);let s=this.currentPassengers.length;this.currentPassengers=this.currentPassengers.filter(i=>i!=this.currentFloor),this.floors.peopleExpected[this.currentFloor]-=s-this.currentPassengers.length,this.animateElevator()}setTimeout(()=>{this.idle=!0},this.c.passengerUnloadingTime)}receiveJob(e){const s=e.getEntryCall(),i=e.getExitCall();this.exitCalls.push(i),this.setEntryCallPassage(s),this.sequence.push(s)}redefinePassage(){for(const e of this.sequence.getHeap())e.isSpecialCall()||this.setEntryCallPassage(e)}setExitCallPassage(e){this.direction==a.UP?e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.setPassage(2):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.setPassage(2)}setEntryCallPassage(e){this.direction==a.UP?e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(3):e.setPassage(2):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(3):e.setPassage(2)}animateElevator(){postMessage({ID:this.ID,currentFloor:this.currentFloor,peopleWaiting:this.floors.peopleWaiting,peopleExpected:this.floors.peopleExpected,currentPassengers:this.currentPassengers.length})}displayElevator(){console.log(`

Elevator ${this.ID}
`),console.log(`------------------------------------------
`);for(let e=0;e<this.N;++e)e==this.currentFloor?console.log(" == "):console.log(e);this.direction==a.UP?console.log(`

-->`):console.log(`

<--`),console.log(`------------------------------------------

`)}}class w{constructor(e,s,i){r(this,"entryCall");r(this,"exitCall");r(this,"ID");this.entryCall=e,this.exitCall=s,this.ID=i}getID(){return this.ID}getEntryCall(){return this.entryCall}getExitCall(){return this.exitCall}}class T{async chooseElevator(e){let s=0,i=!0,o=Number.MAX_VALUE;for(;i;){for(const l of e){const d=(l.sequence.size()+1)*(l.c.velocity*l.c.interFloorHeight+l.c.passengerLoadingTime+l.c.passengerUnloadingTime);d<o&&(o=d,s=l.ID)}e[s].sequence.size()/e[s].c.capacity<.8&&(i=!1),await n(500)}return s}}class C{constructor(e){r(this,"peopleWaiting");r(this,"peopleExpected");this.peopleWaiting=Array(e).fill(0),this.peopleExpected=Array(e).fill(0)}}class I{constructor(){r(this,"N",0);r(this,"L",0);r(this,"U",0);r(this,"algorithm");r(this,"elevatorGroup",[]);r(this,"floors");r(this,"controller");this.controller=new T}setAlgorithm(e){this.algorithm=e}setElevators(e,s){for(let i=0;i<this.elevatorGroup.length;++i)this.elevatorGroup[i].destroy();this.elevatorGroup=[],this.L=e;for(let i=0;i<this.L;++i)setTimeout(()=>{const o=new D(i,this.algorithm,s,this.N,this.L,this.floors);this.elevatorGroup.push(o)},i*50)}setFloors(e){this.N=e,this.floors=new C(e)}async generatePassenger(e,s){const i=Math.round(Math.random()*1e6)+"",o=e>s?a.DOWN:a.UP,l=new h(g.ENTRY,e,o,i);this.floors.peopleWaiting[e]+=1,this.floors.peopleExpected[s]+=1;const F=new h(g.EXIT,s,o,i),d=new w(l,F,i);let E=0;E=await this.controller.chooseElevator(this.elevatorGroup),this.elevatorGroup[E].receiveJob(d)}}const u=new I;function v({floors:t,elevators:e,capacity:s,speed:i,strategy:o}){const l={passengerLoadingTime:300,passengerUnloadingTime:300,velocity:1/i,capacity:s,interFloorHeight:3};u.setAlgorithm(o),u.setFloors(t),u.setElevators(e,l)}onmessage=t=>{console.log(t.data),t.data.type=="es-generate-person"?u==null||u.generatePassenger(t.data.from,t.data.to):t.data.type=="es-update-settings"&&v(t.data)}})();
