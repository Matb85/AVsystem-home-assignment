var k=Object.defineProperty;var U=(l,a,u)=>a in l?k(l,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[a]=u;var r=(l,a,u)=>U(l,typeof a!="symbol"?a+"":a,u);(function(){"use strict";class l{constructor(e,i,s,o){r(this,"type");r(this,"passage",0);r(this,"floor");r(this,"direction");r(this,"ID");r(this,"specialCall");this.type=e,this.floor=i,this.direction=s,this.ID=o,this.specialCall=!1}setPassage(e){this.passage=e}getType(){return this.type}getFloor(){return this.floor}getPassage(){return this.passage}getDirection(){return this.direction}getID(){return this.ID}setSpecialCall(e){this.specialCall=e}isSpecialCall(){return this.specialCall}}function a(t){return new Promise(e=>setTimeout(e,t))}var u=(t=>(t[t.BEFORE_AFTERNOON=0]="BEFORE_AFTERNOON",t[t.AFTER_AFTERNOON=1]="AFTER_AFTERNOON",t))(u||{}),h=(t=>(t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t))(h||{}),c=(t=>(t[t.EXIT=0]="EXIT",t[t.ENTRY=1]="ENTRY",t))(c||{});function N(t,e){if(t.isSpecialCall()||e.isSpecialCall())return t.isSpecialCall()&&!e.isSpecialCall()?-1:!t.isSpecialCall()&&e.isSpecialCall()?1:0;if(t.getPassage()==e.getPassage()){if(t.getPassage()==1||t.getPassage()==3)return t.getFloor()<e.getFloor()?-1:t.getFloor()>e.getFloor()?1:0;if(t.getPassage()==2)return t.getFloor()>e.getFloor()?-1:t.getFloor()<e.getFloor()?1:0}else if(t.getPassage()>e.getPassage())return 1;return-1}const d=t=>(t+1>>>1)-1,P=t=>(t<<1)+1,p=t=>t+1<<1;class E{constructor(){r(this,"_heap");r(this,"top",0);this._heap=[]}size(){return this._heap.length}getHeap(){return this._heap}isEmpty(){return this.size()==0}peek(){return this._heap[this.top]}push(...e){return e.forEach(i=>{this._heap.push(i),this._siftUp()}),this.size()}remove(e){for(let i=0;i<this.size();i++)if(this._heap[i].getID()==e.getID()&&this._heap[i].getType()==e.getType()){this._heap.splice(i,1);break}this._siftDown()}pop(){const e=this.peek(),i=this.size()-1;return i>this.top&&this._swap(this.top,i),this._heap.pop(),this._siftDown(),e}_greater(e,i){return N(this._heap[e],this._heap[i])==-1}_swap(e,i){[this._heap[e],this._heap[i]]=[this._heap[i],this._heap[e]]}_siftUp(){let e=this.size()-1;for(;e>this.top&&this._greater(e,d(e));)this._swap(e,d(e)),e=d(e)}_siftDown(){let e=this.top;for(;P(e)<this.size()&&this._greater(P(e),e)||p(e)<this.size()&&this._greater(p(e),e);){let i=p(e)<this.size()&&this._greater(p(e),P(e))?p(e):P(e);this._swap(e,i),e=i}}}class y{constructor(e,i,s,o,n,g){r(this,"RUNNING",!0);r(this,"entryCalls",[]);r(this,"exitCalls",[]);r(this,"ID");r(this,"currentFloor");r(this,"direction",h.UP);r(this,"idle",!0);r(this,"c");r(this,"currentPassengers",[]);r(this,"floors");r(this,"sequence",new E);r(this,"N");r(this,"L");this.ID=e,this.N=o,this.L=n,this.c=s,this.currentFloor=Math.floor(o/2),this.floors=g,this.startPolling(),i==u.AFTER_AFTERNOON?this.upPeakThread():this.zoningThread(),this.animateElevator()}getID(){return this.ID}getConfig(){return this.c}getCurrentPassengers(){return this.currentPassengers}getCurrentFloor(){return this.currentFloor}isIdle(){return this.idle}destroy(){this.RUNNING=!1,this.entryCalls=[],this.exitCalls=[]}async startPolling(){for(;this.RUNNING;)this.performJob(),await a(200)}async upPeakThread(){for(;this.RUNNING;){if(this.idle&&(await a(4e3),this.idle&&this.currentFloor!=0)){const e=new l(0,0,0,"");e.setPassage(1),e.setSpecialCall(!0),this.sequence.push(e)}await a(200)}}async zoningThread(){const e=Math.ceil(this.N/this.L);for(;this.RUNNING;){if(this.idle&&(await a(4e3),this.idle&&this.currentFloor!=this.ID*e)){const i=new l(0,this.ID*e,0,"");i.setPassage(1),i.setSpecialCall(!0),this.sequence.push(i)}await a(200)}}checkSequence(e){if(e.getType()==c.ENTRY&&e.getFloor()==this.currentFloor&&this.currentPassengers.length<this.c.capacity){this.floors.peopleWaiting[e.getFloor()]-=1;for(let s=0;s<this.exitCalls.length;++s){const o=this.exitCalls[s];if(o.getID()==e.getID()){this.setExitCallPassage(o),this.currentPassengers.push(o.getFloor()),this.sequence.push(o),this.exitCalls.splice(s,1);break}}this.sequence.remove(e)}if(this.sequence.isEmpty())return;const i=this.sequence.getHeap().filter(s=>s.getFloor()==this.currentFloor);for(const s of i){if(s.getType()==c.EXIT){this.sequence.remove(s);continue}if(s.getType()==c.ENTRY&&s.getFloor()==e.getFloor()&&this.currentPassengers.length<this.c.capacity){for(let o=0;o<this.exitCalls.length;++o){const n=this.exitCalls[o];if(n.getID()==s.getID()){this.setExitCallPassage(n),this.currentPassengers.push(n.getFloor()),this.sequence.push(n),this.exitCalls.splice(o,1);break}}this.floors.peopleWaiting[e.getFloor()]-=1,this.sequence.remove(s)}}}async performJob(){if(this.sequence.size()==0||!this.idle)return;const e=this.sequence.peek();if(e.getFloor()==this.currentFloor){this.checkSequence(e),this.idle=!0;return}for(this.idle=!1,e.getFloor()<this.currentFloor?this.direction=h.DOWN:this.direction=h.UP,this.redefinePassage(),await a(this.c.loadingTime);this.currentFloor!=e.getFloor()&&this.currentFloor>=0&&this.currentFloor<=this.N-1;){if(this.idle=!1,this.direction==h.UP&&this.currentFloor!=this.N-1)this.currentFloor+=1;else if(this.direction==h.DOWN&&this.currentFloor!=0)this.currentFloor-=1;else{console.log(`



! + ! + ! Elevator is out of range - this.performJob() ! + ! + !



`);break}await a(this.c.velocity*this.c.interFloorHeight*200),this.redefinePassage(),this.checkSequence(e);let i=this.currentPassengers.length;this.currentPassengers=this.currentPassengers.filter(s=>s!=this.currentFloor),this.floors.peopleExpected[this.currentFloor]-=i-this.currentPassengers.length,this.animateElevator()}setTimeout(()=>{this.idle=!0},this.c.unloadingTime)}receiveJob(e){const i=e.getEntryCall(),s=e.getExitCall();this.exitCalls.push(s),this.setEntryCallPassage(i),this.sequence.push(i)}redefinePassage(){for(const e of this.sequence.getHeap())e.isSpecialCall()||this.setEntryCallPassage(e)}setExitCallPassage(e){this.direction==h.UP?e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.setPassage(2):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.setPassage(2)}setEntryCallPassage(e){this.direction==h.UP?e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(3):e.setPassage(2):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(3):e.setPassage(2)}animateElevator(){this.c.animate({ID:this.ID,currentFloor:this.currentFloor,peopleWaiting:this.floors.peopleWaiting,peopleExpected:this.floors.peopleExpected,currentPassengers:this.currentPassengers.length,direction:this.direction})}}class I{constructor(e,i,s){r(this,"entryCall");r(this,"exitCall");r(this,"ID");this.entryCall=e,this.exitCall=i,this.ID=s}getID(){return this.ID}getEntryCall(){return this.entryCall}getExitCall(){return this.exitCall}}class T{constructor(e){r(this,"exitCalls",[]);r(this,"sequence",new E);r(this,"ID");r(this,"currentFloor");r(this,"direction",h.UP);r(this,"idle",!0);r(this,"c");r(this,"N");r(this,"L");r(this,"currentPassengers",[]);r(this,"cost",0);this.ID=e.getID(),this.N=e.N,this.L=e.L,this.c=e.getConfig(),this.currentFloor=e.getCurrentFloor(),this.sequence.push(...e.sequence.getHeap())}sleep(e){this.cost+=e}checkSequence(e){if(e.getType()==c.ENTRY&&e.getFloor()==this.currentFloor&&this.currentPassengers.length<this.c.capacity){for(let s=0;s<this.exitCalls.length;++s){const o=this.exitCalls[s];if(o.getID()==e.getID()){this.setExitCallPassage(o),this.currentPassengers.push(o.getFloor()),this.sequence.push(o),this.exitCalls.splice(s,1);break}}this.sequence.remove(e)}if(this.sequence.isEmpty())return;const i=this.sequence.getHeap().filter(s=>s.getFloor()==this.currentFloor);for(const s of i){if(s.getType()==c.EXIT){this.sequence.remove(s);continue}if(s.getType()==c.ENTRY&&s.getFloor()==e.getFloor()&&this.currentPassengers.length<this.c.capacity){for(let o=0;o<this.exitCalls.length;++o){const n=this.exitCalls[o];if(n.getID()==s.getID()){this.setExitCallPassage(n),this.currentPassengers.push(n.getFloor()),this.sequence.push(n),this.exitCalls.splice(o,1);break}}this.sequence.remove(s)}}}performJob(){if(this.sequence.size()==0||!this.idle)return;const e=this.sequence.peek();if(e.getFloor()==this.currentFloor){this.checkSequence(e),this.idle=!0;return}for(this.idle=!1,e.getFloor()<this.currentFloor?this.direction=h.DOWN:this.direction=h.UP,this.redefinePassage(),this.sleep(this.c.loadingTime);this.currentFloor!=e.getFloor()&&this.currentFloor>=0&&this.currentFloor<=this.N-1;){if(this.idle=!1,this.direction==h.UP&&this.currentFloor!=this.N-1)this.currentFloor+=1;else if(this.direction==h.DOWN&&this.currentFloor!=0)this.currentFloor-=1;else{console.log(`



! + ! + ! Elevator is out of range - this.performJob() ! + ! + !



`);break}this.sleep(this.c.velocity*this.c.interFloorHeight*200),this.redefinePassage(),this.checkSequence(e),this.currentPassengers=this.currentPassengers.filter(i=>i!=this.currentFloor)}this.sleep(this.c.unloadingTime),this.idle=!0}redefinePassage(){for(const e of this.sequence.getHeap())e.isSpecialCall()||this.setEntryCallPassage(e)}setExitCallPassage(e){this.direction==h.UP?e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.setPassage(2):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.setPassage(2)}setEntryCallPassage(e){this.direction==h.UP?e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(3):e.setPassage(2):e.getFloor()<this.currentFloor&&e.getDirection()==this.direction?e.setPassage(1):e.getFloor()>this.currentFloor&&e.getDirection()==this.direction?e.setPassage(3):e.setPassage(2)}}async function v(t,e){let i=0,s=Number.MAX_VALUE;for(;;){for(const o of t){const n=new T(o),g=e.getEntryCall();for(n.sequence.push(g);n.sequence.peek().getID()!=g.getID()&&n.currentFloor!=g.getFloor();)n.performJob();n.sequence.peek().getID()==g.getID()&&n.performJob();const F=n.cost;F<s&&o.sequence.size()/o.getConfig().capacity<.8&&(s=F,i=o.getID())}if(s==Number.MAX_VALUE)await a(500);else break}return i}class q{constructor(e){r(this,"peopleWaiting");r(this,"peopleExpected");this.peopleWaiting=Array(e).fill(0),this.peopleExpected=Array(e).fill(0)}}class w{constructor(){r(this,"N",0);r(this,"L",0);r(this,"strategy");r(this,"elevatorGroup",[]);r(this,"floors")}setStrategy(e){this.strategy=e}setElevators(e,i){for(let s=0;s<this.elevatorGroup.length;++s)this.elevatorGroup[s].destroy();this.elevatorGroup=[],this.L=e;for(let s=0;s<this.L;++s)setTimeout(()=>{const o=new y(s,this.strategy,i,this.N,this.L,this.floors);this.elevatorGroup.push(o)},s*50)}getElevators(){return this.elevatorGroup}setFloors(e){this.N=e,this.floors=new q(e)}getStatus(){return this.floors}async generatePassenger(e,i){const s=Math.round(Math.random()*1e6)+"",o=e>i?h.DOWN:h.UP,n=new l(c.ENTRY,e,o,s);this.floors.peopleWaiting[e]+=1,this.floors.peopleExpected[i]+=1;const g=new l(c.EXIT,i,o,s),F=new I(n,g,s);let D=0;D=await v(this.elevatorGroup,F),this.elevatorGroup[D].receiveJob(F)}}const f=new w;async function _(t){postMessage(t)}function C({floors:t,elevators:e,capacity:i,speed:s,strategy:o}){const n={loadingTime:300,unloadingTime:300,velocity:1/s,capacity:i,interFloorHeight:3,animate:_};f.setStrategy(o),f.setFloors(t),f.setElevators(e,n)}onmessage=t=>{console.log(t.data),t.data.type=="es-generate-person"?f==null||f.generatePassenger(t.data.from,t.data.to):t.data.type=="es-update-settings"&&C(t.data)}})();
